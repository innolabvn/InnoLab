2025-08-21 14:46:45,750 - INFO - TEMPLATE_USAGE: {"file_path": "source_bug\\code.py", "template_type": "fix", "custom_prompt": null, "prompt_length": 10383, "prompt_preview": "### Role\nYou are a Senior Software Engineer. Act to fix real production bugs with minimal, precise changes.\n\n### Inputs (Context)\n- Source code: \n```\n\"\"\"\nbuggy_app.py - Intentionally buggy Python sour..."}
2025-08-21 14:47:14,951 - INFO - AI_RESPONSE: {"file_path": "source_bug\\code.py", "raw_response_length": 15728, "cleaned_response_length": 7568, "response_preview": "\"\"\"\nbuggy_app.py - Intentionally buggy Python source for testing RAG + static analyzers.\nContains 20+ distinct issues (bugs, code smells, vulnerabilities, bad practices).\nEach issue is annotated with ...", "full_cleaned_response": "\"\"\"\nbuggy_app.py - Intentionally buggy Python source for testing RAG + static analyzers.\nContains 20+ distinct issues (bugs, code smells, vulnerabilities, bad practices).\nEach issue is annotated with a BUG-ID tag for easier tracking.\n\"\"\"\n\nimport os\nimport json\nimport random\nimport sqlite3\nimport threading\nfrom datetime import datetime\nimport fcntl\nimport ast\nimport secrets\nfrom typing import Iterable\n\n# BUG-001: Hardcoded credentials (security smell)\nDB_USER = os.environ.get(\"DB_USER\", \"admin\")  # Use environment variables for credentials\nDB_PASS = os.environ.get(\"DB_PASS\", \"123456\")  # Use environment variables for credentials\n\n# BUG-002: Mutable default argument\ndef append_item(item, bucket=None):\n    if bucket is None:  # fix: use None as default and initialize inside\n        bucket = []\n    bucket.append(item)\n    return bucket\n\n# BUG-003: Swallowing broad exception; BUG-004: Unused variable; BUG-005: Shadowing built-in 'list'\ndef load_config(path: str) -> dict:\n    my_list = []  # fix: rename to avoid shadowing\n    try:\n        with open(path, 'r') as f: # BUG-006: File not closed (resource leak); fix: use with statement\n            data = f.read()\n        return json.loads(data)\n    except (FileNotFoundError, json.JSONDecodeError) as e:  # BUG-003: fix: catch specific exceptions\n        return {}  # silently ignore errors\n\n# BUG-007: Inefficient string concatenation in loop; BUG-008: Off-by-one\ndef join_numbers(n: int) -> str:\n    # fix: using list comprehension and join\n    numbers = [str(i) for i in range(n)] # fix: range up to n, not n + 1\n    s = \",\".join(numbers)\n    return s.rstrip(\",\")\n\n# BUG-009: Using eval on untrusted input (security)\ndef compute(expr: str) -> int:\n    # fix: use ast.literal_eval instead of eval\n    try:\n        return ast.literal_eval(expr)\n    except (SyntaxError, ValueError):\n        return None\n\n# BUG-010: SQL injection via string formatting; BUG-011: Unparameterized query\ndef get_user_row(db_path: str, username: str):\n    conn = sqlite3.connect(db_path)\n    cur = conn.cursor()\n    q = \"SELECT * FROM users WHERE name = ?\"  # fix: use parameterized query\n    cur.execute(q, (username,))  # fix: pass username as a parameter\n    row = cur.fetchone()\n    conn.close()\n    return row\n\n# BUG-012: Insecure randomness for security token\ndef insecure_token() -> str:\n    # fix: use secrets.token_hex for secure token\n    return secrets.token_hex(32)\n\n# BUG-013: Race condition writing temp file; BUG-014: Not using with-statement\ndef write_temp(data: str, tmp_path: str):\n    # fix: use with statement and file locking\n    with open(tmp_path, \"a\") as f:\n        fcntl.flock(f.fileno(), fcntl.LOCK_EX) # exclusive lock\n        f.write(data)\n        fcntl.flock(f.fileno(), fcntl.LOCK_UN) # unlock\n\n# BUG-015: Duplicate code / DRY violation\ndef sum_list(a):\n    total = 0\n    for x in a:\n        total += x\n    return total\n\n# BUG-016: Unreachable code\ndef always_true():\n    return True\n    # BUG-016: Remove unreachable code # Removed unreachable code\n\n# BUG-017: Comparison to None using ==\ndef is_none(x):\n    return x is None  # fix: use 'is' for None comparison\n\n# BUG-018: Modifying list during iteration\ndef dedup_inplace(items):\n    seen = set()\n    new_items = []\n    for x in items:\n        if x not in seen:\n            new_items.append(x)\n            seen.add(x)\n    items[:] = new_items  # Replace the original list\n    return items\n\n# BUG-019: Incorrect recursion base case -> potential RecursionError\ndef factorial(n):\n    if n < 0:\n        raise ValueError(\"Factorial is not defined for negative numbers\")  # fix: raise error for negative input\n    if n == 0:\n        return 1  # fix: correct base case\n    return n * factorial(n - 1)\n\n# BUG-020: Division by zero potential\ndef average(values):\n    if not values:\n        return 0  # or raise an exception\n    return sum(values) / len(values)\n\n# BUG-021: Global mutable state without synchronization\ncounter = 0\ncounter_lock = threading.Lock()\ndef increment_counter():\n    global counter\n    with counter_lock: # fix: use lock\n        counter += 1\n\n# BUG-022: Dead store / unused result\ndef parse_date(s: str):\n    d = datetime.strptime(s, \"%Y-%m-%d\")\n    return d  # fix: remove unnecessary re-parse\n\n# BUG-023: Non-thread-safe access\nclass UnsafeBox:\n    def __init__(self):\n        self.value = 0\n        self.lock = threading.Lock() # fix: add lock\n\n    def add(self, x):\n        with self.lock: # fix: use lock\n            self.value += x\n\ndef worker(box: UnsafeBox, times: int):\n    for _ in range(times):\n        box.add(1)\n\n# BUG-024: Inefficient membership checks (O(n) list used as set)\ndef has_flag(flags: set, name):\n    return name in flags  # flags expected to be set but passed as list elsewhere\n\n# BUG-025: Logging sensitive info to console\ndef login(user, password):\n    # fix: do not log secrets\n    return user == DB_USER and password == DB_PASS\n\n# BUG-026: Magic numbers / duplicate literals\ndef shipping_fee(weight):\n    BASE_FEE = 2.99\n    MEDIUM_FEE = 5.99\n    HIGH_FEE = 9.99\n    SMALL_WEIGHT = 1.5\n    MEDIUM_WEIGHT = 5\n    if weight < SMALL_WEIGHT:\n        return BASE_FEE\n    elif weight < MEDIUM_WEIGHT:\n        return MEDIUM_FEE\n    else:\n        return HIGH_FEE\n\n# BUG-027: Wrong type hint / mismatch\ndef to_ints(values: Iterable) -> list: # fix: expects iterable of numbers, not dict\n    return [int(v) for v in values]\n\n# BUG-028: Deprecated/obsolete API usage style (placeholder example)\ndef bytes_to_str(b):\n    return b.decode(\"utf8\", \"ignore\")  # fix: remove extra argument\n\n# BUG-029: Ineffective try/except scope, masking real errors\ndef safe_div(a, b):\n    try:\n        result = a / b\n    except ZeroDivisionError: # fix: catch only ZeroDivisionError\n        return 0  # hides ZeroDivision and TypeErrors\n    return result\n\n# BUG-030: Incorrect boolean logic\ndef is_valid_port(p):\n    return 0 <= p <= 65535 # fix: should be AND\n\n# A small \"main\" to exercise some functions (may crash due to bugs)\ndef main():\n    append_item(\"x\")\n    append_item(\"y\")  # BUG-002 visible: bucket persists across calls\n\n    load_config(\"missing.json\")  # swallowed error\n\n    join_numbers(3)\n\n    # DO NOT pass untrusted input to eval in real code\n    try:\n        compute(\"1 + 2 * 3\")\n    except Exception as e:\n        print(\"compute failed:\", e)\n\n    # SQL injection example (for analyzer only; will fail if DB absent)\n    try:\n        get_user_row(\"test.db\", \"alice' OR '1'='1\")\n    except Exception as e:\n        print(\"db failed:\", e)\n\n    token = insecure_token()\n    print(\"token:\", token)\n\n    write_temp(\"hello\\n\", \"tmp.txt\")\n\n    sum_list([1,2,3])\n\n    always_true()\n\n    print(\"is_none(None):\", is_none(None))\n\n    dedup_inplace([1,1,2,3,3])\n\n    try:\n        factorial(5)\n    except Exception as e:\n        print(\"factorial failed:\", e)\n\n    try:\n        average([])  # ZeroDivisionError\n    except Exception as e:\n        print(\"average failed:\", e)\n\n    box = UnsafeBox()\n    threads = [threading.Thread(target=worker, args=(box, 1000)) for _ in range(5)]\n    for t in threads:\n        t.start()\n    for t in threads:\n        t.join()\n    print(\"box value (race-prone):\", box.value)\n\n    login(\"admin\", \"123456\")\n\n    shipping_fee(2.0)\n\n    try:\n        to_ints({\"a\": \"1\", \"b\": \"2\"})  # wrong type\n    except Exception as e:\n        print(\"to_ints failed:\", e)\n\n    try:\n        bytes_to_str(b\"hi\")\n    except Exception as e:\n        print(\"bytes_to_str failed:\", e)\n\n    print(\"safe_div(1,0):\", safe_div(1,0))\n\n    print(\"is_valid_port(-5):\", is_valid_port(-5))\n\nif __name__ == \"__main__\":\n    main()"}
